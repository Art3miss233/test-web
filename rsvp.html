<!-- RSVP Form HTML -->
<form id="rsvp-form" class="rsvp-form">
  <!-- Guest Name with autocomplete suggestions -->
  <label for="guestName">Guest Name:</label>
  <input type="text" id="guestName" name="guestName" list="guestList" placeholder="Start typing your name..." required />

  <datalist id="guestList"></datalist>  <!-- dynamically populated by JS -->

  <!-- Attendance dropdown -->
  <label for="attendance">Will you attend?</label>
  <select id="attendance" name="attendance" required>
    <option value="">-- Select an option --</option>
    <option value="Yes">Yes, I will attend</option>
    <option value="No">No, I cannot attend</option>
  </select>

  <!-- Meal preference (for primary guest) -->
  <label for="meal">Meal Preference:</label>
  <select id="meal" name="meal" required>
    <option value="">-- Select a meal preference --</option>
    <option value="Non-Vegetarian">Non-Vegetarian</option>
    <option value="Vegetarian">Vegetarian</option>
    <option value="Vegan">Vegan</option>
  </select>

  <!-- Plus One section (initially hidden until needed) -->
  <fieldset id="plusOneSection">
    <legend>Plus One (Guest) Details <em>(if applicable)</em></legend>

    <label for="plusOneName">Plus One Name:</label>
    <input type="text" id="plusOneName" name="plusOneName" placeholder="Your guest's name (optional)" />

    <div id="plusOneExtra" style="display:none; margin-left: 1em;">
      <label for="plusOneAttendance">Will your guest attend?</label>
      <select id="plusOneAttendance" name="plusOneAttendance">
        <option value="">-- Select an option --</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>

      <label for="plusOneMeal">Guest Meal Preference:</label>
      <select id="plusOneMeal" name="plusOneMeal">
        <option value="">-- Select a meal preference --</option>
        <option value="Non-Vegetarian">Non-Vegetarian</option>
        <option value="Vegetarian">Vegetarian</option>
        <option value="Vegan">Vegan</option>
      </select>
    </div>
  </fieldset>

  <!-- Dietary restrictions and song request -->
  <label for="dietaryRestrictions">Dietary Restrictions (allergies, etc.):</label>
  <textarea id="dietaryRestrictions" name="dietaryRestrictions" rows="2" placeholder="Let us know of any dietary needs"></textarea>

  <label for="songRequest">Song Request (for the dance floor):</label>
  <input type="text" id="songRequest" name="songRequest" placeholder="Suggest a song!" />

  <!-- Submit button -->
  <button type="submit">Send RSVP</button>

  <!-- Placeholder for success/error messages -->
  <p id="responseMsg" style="font-weight: bold; margin-top: 1em;"></p>
</form>

<script>
// === Configuration ===
const scriptURL = "https://script.google.com/macros/s/AKfycbwS5MsSUIuJ1L9iEOHjeeDyWnbAHySeNp7kvFL0Oa747r-0JM24f-GVFkgC3WQFmOgl/exec";  // TODO: replace with deployed Apps Script URL

// Fetch guest list from Google Sheet on page load and populate the datalist
fetch(scriptURL + "?guestlist=true")
  .then(response => response.json())
  .then(names => {
    const dataList = document.getElementById('guestList');
    dataList.innerHTML = "";  // clear any existing options
    names.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      dataList.appendChild(opt);
    });
  })
  .catch(err => console.error("Error loading guest list:", err));

// Handle dynamic display of plus-one fields
const attendanceSelect = document.getElementById('attendance');
const plusOneSection = document.getElementById('plusOneSection');
const plusOneNameInput = document.getElementById('plusOneName');
const plusOneExtraDiv = document.getElementById('plusOneExtra');
attendanceSelect.addEventListener('change', () => {
  if (attendanceSelect.value === "Yes") {
    plusOneSection.style.display = "block";   // show plus-one section if attending
    document.getElementById('meal').disabled = false;
  } else {
    // If not attending, hide plus-one section and disable meal choice
    plusOneSection.style.display = "none";
    document.getElementById('meal').disabled = true;
    // Also clear any plus-one inputs
    plusOneNameInput.value = "";
    plusOneExtraDiv.style.display = "none";
  }
});
plusOneNameInput.addEventListener('input', () => {
  // If a plus-one name is entered, show their attendance/meal fields
  if (plusOneNameInput.value.trim() !== "") {
    plusOneExtraDiv.style.display = "block";
    // Mark plus-one subfields as required when visible
    document.getElementById('plusOneAttendance').required = true;
    document.getElementById('plusOneMeal').required = true;
  } else {
    // Hide plus-one subfields if name is cleared
    plusOneExtraDiv.style.display = "none";
    document.getElementById('plusOneAttendance').required = false;
    document.getElementById('plusOneMeal').required = false;
    document.getElementById('plusOneAttendance').value = "";
    document.getElementById('plusOneMeal').value = "";
  }
});

// Handle form submission via AJAX (prevent default form submit)
const form = document.getElementById('rsvp-form');
const responseMsg = document.getElementById('responseMsg');
form.addEventListener('submit', e => {
  e.preventDefault();
  responseMsg.textContent = "";  // clear previous message

  // Prepare form data for submission
  const formData = new FormData(form);

  // Optionally, you could add client-side validation here (beyond HTML5) 
  // e.g., ensure meal preferences are selected if attending, etc.

  // Submit the form data to Google Apps Script using fetch
  fetch(scriptURL, { method: 'POST', body: formData })  // Using FormData avoids CORS preflight:contentReference[oaicite:3]{index=3}
    .then(response => response.json())
    .then(data => {
      if (data.result === "success") {
        // Show success message and optionally reset the form
        responseMsg.style.color = "green";
        responseMsg.textContent = "Thank you! Your RSVP has been recorded.";
        form.reset();
        plusOneExtraDiv.style.display = "none";  // hide plus-one extra fields after reset
      } else {
        // Show error message returned by server
        responseMsg.style.color = "red";
        responseMsg.textContent = "Error: " + (data.message || "Could not submit RSVP.");
      }
    })
    .catch(error => {
      console.error("Submission error:", error);
      responseMsg.style.color = "red";
      responseMsg.textContent = "Error submitting form. Please try again.";
    });
});
</script>
